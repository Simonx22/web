(function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,t.adapter=e()}})(function(){return function(){function s(d,e,r){function t(o,i){if(!e[o]){if(!d[o]){var l="function"==typeof require&&require;if(!i&&l)return l(o,!0);if(n)return n(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var a=e[o]={exports:{}};d[o][0].call(a.exports,function(e){var r=d[o][1][e];return t(r||e)},a,a.exports,s,d,e,r)}return e[o].exports}for(var n="function"==typeof require&&require,a=0;a<r.length;a++)t(r[a]);return t}return s}()({1:[function(e,t){'use strict';var r=e("./adapter_factory.js"),n=(0,r.adapterFactory)({window:window});t.exports=n},{"./adapter_factory.js":2}],2:[function(e,t,r){'use strict';function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},t=e.window,r=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},n=i.log,a=i.detectBrowser(t),o={browserDetails:a,commonShim:f,extractVersion:i.extractVersion,disableLog:i.disableLog,disableWarnings:i.disableWarnings};switch(a.browser){case"chrome":if(!s||!s.shimPeerConnection||!r.shimChrome)return n("Chrome shim is not included in this adapter release."),o;n("adapter.js shimming chrome."),o.browserShim=s,s.shimGetUserMedia(t),s.shimMediaStream(t),s.shimPeerConnection(t),s.shimOnTrack(t),s.shimAddTrackRemoveTrack(t),s.shimGetSendersWithDtmf(t),s.shimGetStats(t),s.shimSenderReceiverGetStats(t),s.fixNegotiationNeeded(t),f.shimRTCIceCandidate(t),f.shimConnectionState(t),f.shimMaxMessageSize(t),f.shimSendThrowTypeError(t),f.removeAllowExtmapMixed(t);break;case"firefox":if(!l||!l.shimPeerConnection||!r.shimFirefox)return n("Firefox shim is not included in this adapter release."),o;n("adapter.js shimming firefox."),o.browserShim=l,l.shimGetUserMedia(t),l.shimPeerConnection(t),l.shimOnTrack(t),l.shimRemoveStream(t),l.shimSenderGetStats(t),l.shimReceiverGetStats(t),l.shimRTCDataChannel(t),l.shimAddTransceiver(t),l.shimCreateOffer(t),l.shimCreateAnswer(t),f.shimRTCIceCandidate(t),f.shimConnectionState(t),f.shimMaxMessageSize(t),f.shimSendThrowTypeError(t);break;case"edge":if(!c||!c.shimPeerConnection||!r.shimEdge)return n("MS edge shim is not included in this adapter release."),o;n("adapter.js shimming edge."),o.browserShim=c,c.shimGetUserMedia(t),c.shimGetDisplayMedia(t),c.shimPeerConnection(t),c.shimReplaceTrack(t),f.shimMaxMessageSize(t),f.shimSendThrowTypeError(t);break;case"safari":if(!u||!r.shimSafari)return n("Safari shim is not included in this adapter release."),o;n("adapter.js shimming safari."),o.browserShim=u,u.shimRTCIceServerUrls(t),u.shimCreateOfferLegacy(t),u.shimCallbacksAPI(t),u.shimLocalStreamsAPI(t),u.shimRemoteStreamsAPI(t),u.shimTrackEventTransceiver(t),u.shimGetUserMedia(t),f.shimRTCIceCandidate(t),f.shimMaxMessageSize(t),f.shimSendThrowTypeError(t),f.removeAllowExtmapMixed(t);break;default:n("Unsupported browser!");}return o};var a=e("./utils"),i=n(a),o=e("./chrome/chrome_shim"),s=n(o),d=e("./edge/edge_shim"),c=n(d),p=e("./firefox/firefox_shim"),l=n(p),m=e("./safari/safari_shim"),u=n(m),g=e("./common_shim"),f=n(g)},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){'use strict';function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(t){if("object"===("undefined"==typeof t?"undefined":d(t))&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return this._ontrackpoly||(this._ontrackpoly=function(r){r.stream.addEventListener("addtrack",function(e){var a=t.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(t){return t.track&&t.track.id===e.track.id}):{track:e.track};var i=new Event("track");i.track=e.track,i.receiver=a,i.transceiver={receiver:a},i.streams=[r.stream],n.dispatchEvent(i)}),r.stream.getTracks().forEach(function(e){var a=t.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(t){return t.track&&t.track.id===e.id}):{track:e};var i=new Event("track");i.track=e,i.receiver=a,i.transceiver={receiver:a},i.streams=[r.stream],n.dispatchEvent(i)})},this.addEventListener("addstream",this._ontrackpoly)),r.apply(this,arguments)}}else m.wrapPeerConnectionEvent(t,"track",function(t){return t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t})}function i(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e){var n=r.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach(function(e){r._senders.push(t(r,e))})};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(function(e){var r=t._senders.find(function(t){return t.track===e});r&&t._senders.splice(t._senders.indexOf(r),1)})}}else if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var o=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=o.apply(this,[]);return t.forEach(function(t){return t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function o(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach(function(t){return t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return m.filterStats(t,e.track,!0)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var n=e.RTCPeerConnection.prototype.getReceivers;n&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=n.apply(this,[]);return t.forEach(function(t){return t._pc=e}),t}),m.wrapPeerConnectionEvent(e,"track",function(t){return t.receiver._pc=t.srcElement,t}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return m.filterStats(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,n=void 0,i=void 0;return(this.getSenders().forEach(function(e){e.track===t&&(r?i=!0:r=e)}),this.getReceivers().forEach(function(e){return e.track===t&&(n?i=!0:n=e),e.track===t}),i||r&&n)?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return a.apply(this,arguments)}}}}function s(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){var r=t.getSenders().find(function(t){return t.track===e});if(r)throw new DOMException("Track already exists.","InvalidAccessError")});var n=this.getSenders();r.apply(this,arguments);var a=this.getSenders().filter(function(e){return-1===n.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(a)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};var a=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(r){var n=t._shimmedLocalStreams[r].indexOf(e);-1!==n&&t._shimmedLocalStreams[r].splice(n,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]}),a.apply(this,arguments)}}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return c.shimGetUserMedia}});var p=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return p.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=a,r.shimGetSendersWithDtmf=i,r.shimGetStats=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=this,r=Array.prototype.slice.call(arguments),n=r[0],a=r[1],i=r[2];if(0<arguments.length&&"function"==typeof n)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof n))return t.apply(this,[]);var o=function(e){var t={},r=e.result();return r.forEach(function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){r[t]=e.stat(t)}),t[r.id]=r}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(2<=arguments.length){var d=function(e){a(s(o(e)))};return t.apply(this,[d,n])}return new Promise(function(r,n){t.apply(e,[function(e){r(s(o(e)))},n])}).then(a,i)}}},r.shimSenderReceiverGetStats=o,r.shimAddTrackRemoveTrackWithNative=s,r.shimAddTrackRemoveTrack=function(e){function t(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t],a=e._streams[n.id];r=r.replace(new RegExp(a.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:r})}function r(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t],a=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),a.id)}),new RTCSessionDescription({type:t.type,sdp:r})}if(e.RTCPeerConnection){var a=m.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&65<=a.version)return s(e);var i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=i.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(function(e){var t=r.getSenders().find(function(t){return t.track===e});if(t)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){var n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}o.apply(this,[t])};var d=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(r,n){var a=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(function(e){return e===r}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var o=this.getSenders().find(function(e){return e.track===r});if(o)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var s=this._streams[n.id];if(s)s.addTrack(r),Promise.resolve().then(function(){a.dispatchEvent(new Event("negotiationneeded"))});else{var d=new e.MediaStream([r]);this._streams[n.id]=d,this._reverseStreams[d.id]=n,this.addStream(d)}return this.getSenders().find(function(e){return e.track===r})},["createOffer","createAnswer"].forEach(function(r){var a=e.RTCPeerConnection.prototype[r],i=n({},r,function(){var e=this,r=arguments,n=arguments.length&&"function"==typeof arguments[0];return n?a.apply(this,[function(n){var a=t(e,n);r[0].apply(null,[a])},function(e){r[1]&&r[1].apply(null,e)},arguments[2]]):a.apply(this,arguments).then(function(r){return t(e,r)})});e.RTCPeerConnection.prototype[r]=i[r]});var c=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=r(this,arguments[0]),c.apply(this,arguments)):c.apply(this,arguments)};var p=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=p.get.apply(this);return""===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var r=e._pc===this;if(!r)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var n;Object.keys(this._streams).forEach(function(r){var a=t._streams[r].getTracks().find(function(t){return e.track===t});a&&(n=t._streams[r])}),n&&(1===n.getTracks().length?this.removeStream(this._reverseStreams[n.id]):n.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}},r.shimPeerConnection=function(e){var t=m.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!!e.RTCPeerConnection){var r=0===e.RTCPeerConnection.prototype.addIceCandidate.length;53>t.version&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t],a=n({},t,function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)});e.RTCPeerConnection.prototype[t]=a[t]});var a=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return r||arguments[0]?78>t.version&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():a.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},r.fixNegotiationNeeded=function(e){m.wrapPeerConnectionEvent(e,"negotiationneeded",function(t){var e=t.target;return"stable"===e.signalingState?t:void 0})};var l=e("../utils.js"),m=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(l)},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){'use strict';function n(e,t){return e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices?void 0:e.navigator.mediaDevices?"function"==typeof t?void(e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(function(t){var n=r.video&&r.video.width,a=r.video&&r.video.height,i=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:i||3}},n&&(r.video.mandatory.maxWidth=n),a&&(r.video.mandatory.maxHeight=a),e.navigator.mediaDevices.getUserMedia(r)})}):void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void 0}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=n},{}],5:[function(e,t,r){'use strict';Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices){var r=i.detectBrowser(e),a=function(e){if("object"!==("undefined"==typeof e?"undefined":n(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(a){if("require"!==a&&"advanced"!==a&&"mediaSource"!==a){var i="object"===n(e[a])?e[a]:{ideal:e[a]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var o={};"number"==typeof i.ideal?(o[r("min",a)]=i.ideal,t.optional.push(o),o={},o[r("max",a)]=i.ideal,t.optional.push(o)):(o[r("",a)]=i.ideal,t.optional.push(o))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",a)]=i.exact):["min","max"].forEach(function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,a)]=i[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,i){if(61<=r.version)return i(e);if(e=JSON.parse(JSON.stringify(e)),e&&"object"===n(e.audio)){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};e=JSON.parse(JSON.stringify(e)),s(e.audio,"autoGainControl","googAutoGainControl"),s(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"===n(e.video)){var d=e.video.facingMode;d=d&&("object"===("undefined"==typeof d?"undefined":n(d))?d:{ideal:d});var c=66>r.version;if(d&&("user"===d.exact||"environment"===d.exact||"user"===d.ideal||"environment"===d.ideal)&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!c)){delete e.video.facingMode;var p;if("environment"===d.exact||"environment"===d.ideal?p=["back","rear"]:("user"===d.exact||"user"===d.ideal)&&(p=["front"]),p)return t.mediaDevices.enumerateDevices().then(function(t){t=t.filter(function(e){return"videoinput"===e.kind});var r=t.find(function(e){return p.some(function(t){return e.label.toLowerCase().includes(t)})});return!r&&t.length&&p.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=d.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=a(e.video),o("chrome: "+JSON.stringify(e)),i(e)})}e.video=a(e.video)}return o("chrome: "+JSON.stringify(e)),i(e)},d=function(t){return 64<=r.version?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},c=function(e,r,n){s(e,function(e){t.webkitGetUserMedia(e,r,function(t){n&&n(d(t))})})};if(t.getUserMedia=c.bind(t),t.mediaDevices.getUserMedia){var p=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return s(e,function(e){return p(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(t){return Promise.reject(d(t))})})}}}};var a=e("../utils.js"),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(a),o=i.log},{"../utils.js":15}],6:[function(e,t,r){'use strict';function n(t){if(!(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)){var r=t.RTCIceCandidate;t.RTCIceCandidate=function(e){if("object"===("undefined"==typeof e?"undefined":s(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&(e=JSON.parse(JSON.stringify(e)),e.candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var t=new r(e),n=c.default.parseCandidate(e.candidate),a=Object.assign(t,n);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new r(e)},t.RTCIceCandidate.prototype=r.prototype,l.wrapPeerConnectionEvent(t,"icecandidate",function(r){return r.candidate&&Object.defineProperty(r,"candidate",{value:new t.RTCIceCandidate(r.candidate),writable:"false"}),r})}}function a(e){if(e.RTCPeerConnection){var t=l.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp}});var r=function(e){if(!e||!e.sdp)return!1;var t=c.default.splitSections(e.sdp);return t.shift(),t.some(function(e){var t=c.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||2>t.length)return-1;var r=parseInt(t[1],10);return r===r?r:-1},a=function(e){var r=65536;return"firefox"===t.browser&&(57>t.version?-1===e?r=16384:r=2147483637:60>t.version?r=57===t.version?65535:65536:r=2147483637),r},i=function(e,r){var n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);var a=c.default.matchPrefix(e.sdp,"a=max-message-size:");return 0<a.length?n=parseInt(a[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&76<=t.version){var e=this.getConfiguration(),s=e.sdpSemantics;"plan-b"===s&&Object.defineProperty(this,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(r(arguments[0])){var d=n(arguments[0]),c=a(d),p=i(arguments[0],d),l=void 0;l=0===c&&0===p?Number.POSITIVE_INFINITY:0===c||0===p?Math.max(c,p):Math.min(c,p);var m={};Object.defineProperty(m,"maxMessageSize",{get:function(){return l}}),this._sctp=m}return o.apply(this,arguments)}}}function i(e){function t(e,t){var r=e.send;e.send=function(){var n=arguments[0],a=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&a>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=r.apply(this,arguments);return t(e,this),e},l.wrapPeerConnectionEvent(e,"datachannel",function(r){return t(r.channel,r.target),r})}}function o(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(t){var e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;var r=new Event("connectionstatechange",t);e.dispatchEvent(r)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}}Object.defineProperty(r,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=n,r.shimMaxMessageSize=a,r.shimSendThrowTypeError=i,r.shimConnectionState=o,r.removeAllowExtmapMixed=function(e){if(e.RTCPeerConnection){var t=l.detectBrowser(e);if(!("chrome"===t.browser&&71<=t.version)){var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(function(e){return"a=extmap-allow-mixed"!==e.trim()}).join("\n")),r.apply(this,arguments)}}}};var d=e("sdp"),c=function(e){return e&&e.__esModule?e:{default:e}}(d),p=e("./utils"),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(p)},{"./utils":15,sdp:17}],7:[function(e,t,r){'use strict';function n(e){var t=d.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),15025>t.version)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var n=(0,l.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,c.filterIceServers)(e.iceServers,t.version),d.log("ICE servers after filtering:",e.iceServers)),new n(e)},e.RTCPeerConnection.prototype=n.prototype}function a(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimPeerConnection=n,r.shimReplaceTrack=a;var s=e("../utils"),d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(s),c=e("./filtericeservers"),p=e("rtcpeerconnection-shim"),l=function(e){return e&&e.__esModule?e:{default:e}}(p)},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){'use strict';Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e){var t=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&a.deprecated("RTCIceServer.url","RTCIceServer.urls");var n="string"==typeof r;return n&&(r=[r]),r=r.filter(function(e){if(0===e.indexOf("stun:"))return!1;var r=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return r&&!t?(t=!0,!0):r&&!t}),delete e.url,e.urls=n?r[0]:r,!!r.length}})};var n=e("../utils"),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(n)},{"../utils":15}],9:[function(e,t,r){'use strict';function n(e){!("getDisplayMedia"in e.navigator)||!e.navigator.mediaDevices||e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator))}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=n},{}],10:[function(e,t,r){'use strict';Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=function(t){return{name:{PermissionDeniedError:"NotAllowedError"}[t.name]||t.name,message:t.message,constraint:t.constraint,toString:function(){return this.name}}},n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch(function(t){return Promise.reject(r(t))})}}},{}],11:[function(e,t,r){'use strict';function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e){"object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function i(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach(function(t){return t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}}function o(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach(function(t){return t._pc=e}),r}),m.wrapPeerConnectionEvent(e,"track",function(t){return t.receiver._pc=t.srcElement,t}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}}function s(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;m.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)})})}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return c.shimGetUserMedia}});var p=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return p.shimGetDisplayMedia}}),r.shimOnTrack=a,r.shimPeerConnection=function(e){var t=m.detectBrowser(e);if("object"===("undefined"==typeof e?"undefined":d(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),53>t.version&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t],a=n({},t,function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)});e.RTCPeerConnection.prototype[t]=a[t]}),68>t.version){var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}var a={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=Array.prototype.slice.call(arguments),r=e[0],n=e[1],o=e[2];return i.apply(this,[r||null]).then(function(r){if(53>t.version&&!n)try{r.forEach(function(e){e.type=a[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;r.forEach(function(e,t){r.set(t,Object.assign({},e,{type:a[e.type]||e.type}))})}return r}).then(n,o)}}},r.shimSenderGetStats=i,r.shimReceiverGetStats=o,r.shimRemoveStream=s,r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},r.shimAddTransceiver=function(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach(function(e){if("rid"in e){var t=/^[a-z0-9]{0,16}$/i;if(!t.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(1<=parseFloat(e.scaleResolutionDownBy)))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(0<=parseFloat(e.maxFramerate)))throw new RangeError("max_framerate must be >= 0.0")});var n=t.apply(this,arguments);if(r){var a=n.sender,i=a.getParameters();"encodings"in i||(i.encodings=e.sendEncodings,this.setParametersPromises.push(a.setParameters(i).catch(function(){})))}return n})}},r.shimCreateOffer=function(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return t.apply(e,r)}).finally(function(){e.setParametersPromises=[]}):t.apply(this,arguments)}}},r.shimCreateAnswer=function(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return t.apply(e,r)}).finally(function(){e.setParametersPromises=[]}):t.apply(this,arguments)}}};var l=e("../utils"),m=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(l)},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){'use strict';function n(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||!e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!(r&&r.video)){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=n},{}],13:[function(e,t,r){'use strict';function n(e){var t=o.detectBrowser(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){o.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n)},!(55<t.version&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var i=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},s=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===("undefined"==typeof e?"undefined":a(e))&&"object"===a(e.audio)&&(e=JSON.parse(JSON.stringify(e)),i(e.audio,"autoGainControl","mozAutoGainControl"),i(e.audio,"noiseSuppression","mozNoiseSuppression")),s(e)},n&&n.prototype.getSettings){var d=n.prototype.getSettings;n.prototype.getSettings=function(){var e=d.apply(this,arguments);return i(e,"mozAutoGainControl","autoGainControl"),i(e,"mozNoiseSuppression","noiseSuppression"),e}}if(n&&n.prototype.applyConstraints){var p=n.prototype.applyConstraints;n.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===("undefined"==typeof e?"undefined":a(e))&&(e=JSON.parse(JSON.stringify(e)),i(e,"autoGainControl","mozAutoGainControl"),i(e,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[e])}}}}Object.defineProperty(r,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=n;var i=e("../utils"),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(i)},{"../utils":15}],14:[function(e,t,r){'use strict';function n(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(function(n){return t.call(r,n,e)}),e.getVideoTracks().forEach(function(n){return t.call(r,n,e)})},e.RTCPeerConnection.prototype.addTrack=function(){for(var e=this,r=arguments.length,n=Array(1<r?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return n&&n.forEach(function(t){e._localStreams?!e._localStreams.includes(t)&&e._localStreams.push(t):e._localStreams=[t]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var n=e.getTracks();this.getSenders().forEach(function(e){n.includes(e.track)&&t.removeTrack(e)})}})}}function a(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}})})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(0<=e._remoteStreams.indexOf(t))){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}})}),t.apply(e,arguments)}}}function i(e){return e&&void 0!==e.video?Object.assign({},e,{video:p.compactObject(e.video)}):e}function o(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var n,a=[],o=0;o<e.iceServers.length;o++)n=e.iceServers[o],!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(p.deprecated("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,a.push(n)):a.push(e.iceServers[o]);e.iceServers=a}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})}function s(e){"object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}Object.defineProperty(r,"__esModule",{value:!0});var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=n,r.shimRemoteStreamsAPI=a,r.shimCallbacksAPI=function(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,a=t.setLocalDescription,i=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){var n=2<=arguments.length?arguments[2]:arguments[0],a=r.apply(this,[n]);return t?(a.then(e,t),Promise.resolve()):a},t.createAnswer=function(e,t){var r=2<=arguments.length?arguments[2]:arguments[0],a=n.apply(this,[r]);return t?(a.then(e,t),Promise.resolve()):a};var s=function(e,t,r){var n=a.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=s,s=function(e,t,r){var n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=s,s=function(e,t,r){var n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=s}},r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices,n=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return n(i(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t))},r.shimConstraints=i,r.shimRTCIceServerUrls=o,r.shimTrackEventTransceiver=s,r.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){"undefined"!=typeof e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find(function(e){return"audio"===e.receiver.track.kind});!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0===e.offerToReceiveAudio&&!r&&this.addTransceiver("audio"),"undefined"!=typeof e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var n=this.getTransceivers().find(function(e){return"video"===e.receiver.track.kind});!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0===e.offerToReceiveVideo&&!n&&this.addTransceiver("video")}return t.apply(this,arguments)}};var c=e("../utils"),p=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(c)},{"../utils":15}],15:[function(e,t,r){'use strict';function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function i(){if("object"===("undefined"==typeof window?"undefined":l(window))){if(m)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function o(e,t){u&&console.warn(e+" is deprecated, please use "+t+" instead.")}function s(e){var t=e.navigator,r={browser:null,version:null};if("undefined"==typeof e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=a(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=a(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=a(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(e.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))r.browser="safari",r.version=a(t.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;else return r.browser="Not a supported browser.",r;return r}function d(e){return"[object Object]"===Object.prototype.toString.call(e)}function c(e){return d(e)?Object.keys(e).reduce(function(t,r){var a=d(e[r]),i=a?c(e[r]):e[r],o=a&&!Object.keys(i).length;return void 0===i||o?t:Object.assign(t,n({},r,i))},{}):e}function p(e,t,r){!t||r.has(t.id)||(r.set(t.id,t),Object.keys(t).forEach(function(n){n.endsWith("Id")?p(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach(function(t){p(e,e.get(t),r)})}))}Object.defineProperty(r,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.extractVersion=a,r.wrapPeerConnectionEvent=function(e,t,r){if(e.RTCPeerConnection){var n=e.RTCPeerConnection.prototype,a=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return a.apply(this,arguments);var i=function(t){var e=r(t);e&&n(e)};return this._eventMap=this._eventMap||{},this._eventMap[n]=i,a.apply(this,[e,i])};var i=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return i.apply(this,arguments);var n=this._eventMap[r];return delete this._eventMap[r],i.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},r.disableLog=function(e){return"boolean"==typeof e?(m=e,e?"adapter.js logging disabled":"adapter.js logging enabled"):new Error("Argument type: "+("undefined"==typeof e?"undefined":l(e))+". Please use a boolean.")},r.disableWarnings=function(e){return"boolean"==typeof e?(u=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled")):new Error("Argument type: "+("undefined"==typeof e?"undefined":l(e))+". Please use a boolean.")},r.log=i,r.deprecated=o,r.detectBrowser=s,r.compactObject=c,r.walkStats=p,r.filterStats=function(e,t,r){var n=r?"outbound-rtp":"inbound-rtp",a=new Map;if(null===t)return a;var i=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&i.push(e)}),i.forEach(function(t){e.forEach(function(r){r.type===n&&r.trackId===t.id&&p(e,r,a)})}),a};var m=!0,u=!0},{}],16:[function(e,t){'use strict';function r(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type}function n(e,t,r,n,a){var i=c.writeRtpDescription(e.kind,t);if(i+=c.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=c.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":a||"active"),i+="a=mid:"+e.mid+"\r\n",i+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var s="msid:"+(n?n.id:"-")+" "+o+"\r\n";i+="a="+s,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+c.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+c.localCName+"\r\n"),i}function a(e,t){var r=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var a="string"==typeof n;return a&&(n=[n]),n=n.filter(function(e){var n=0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r;return n?(r=!0,!0):0===e.indexOf("stun:")&&14393<=t&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=a?n[0]:n,!!n.length}})}function i(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},a=function(e,t,r,a){var i=n(e.parameters.apt,r),o=n(t.parameters.apt,a);return i&&o&&i.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(n){for(var o,s=0;s<t.codecs.length;s++)if(o=t.codecs[s],n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!a(n,o,e.codecs,t.codecs))continue;o=JSON.parse(JSON.stringify(o)),o.numChannels=Math.min(n.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}),e.headerExtensions.forEach(function(e){for(var n,a=0;a<t.headerExtensions.length;a++)if(n=t.headerExtensions[a],e.uri===n.uri){r.headerExtensions.push(n);break}}),r}function o(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function s(e,t){var r=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return r||e.addRemoteCandidate(t),!r}function d(t,r){var n=new Error(r);return n.name=t,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],n}var c=e("sdp");t.exports=function(e,t){function p(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function l(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function m(t,r,n,a){var i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=a,e.setTimeout(function(){t._dispatchEvent("track",i)})}var u=function(r){var n=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){n[e]=o[e].bind(o)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw d("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");else r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require");switch(r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all";}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced";}if(r.iceServers=a(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var s=r.iceCandidatePoolSize;0<s;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=c.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(u.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(u.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),u.prototype.onicecandidate=null,u.prototype.onaddstream=null,u.prototype.ontrack=null,u.prototype.onremovestream=null,u.prototype.onsignalingstatechange=null,u.prototype.oniceconnectionstatechange=null,u.prototype.onconnectionstatechange=null,u.prototype.onicegatheringstatechange=null,u.prototype.onnegotiationneeded=null,u.prototype.ondatachannel=null,u.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},u.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},u.prototype.getConfiguration=function(){return this._config},u.prototype.getLocalStreams=function(){return this.localStreams},u.prototype.getRemoteStreams=function(){return this.remoteStreams},u.prototype._createTransceiver=function(e,t){var r=0<this.transceivers.length,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var a=this._createIceAndDtlsTransports();n.iceTransport=a.iceTransport,n.dtlsTransport=a.dtlsTransport}return t||this.transceivers.push(n),n},u.prototype.addTrack=function(t,r){if(this._isClosed)throw d("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n=this.transceivers.find(function(e){return e.track===t});if(n)throw d("InvalidAccessError","Track already exists.");for(var a,o=0;o<this.transceivers.length;o++)this.transceivers[o].track||this.transceivers[o].kind!==t.kind||(a=this.transceivers[o]);return a||(a=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),a.track=t,a.stream=r,a.rtpSender=new e.RTCRtpSender(t,a.dtlsTransport),a.rtpSender},u.prototype.addStream=function(e){var r=this;if(15025<=t)e.getTracks().forEach(function(t){r.addTrack(t,e)});else{var n=e.clone();e.getTracks().forEach(function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",function(e){r.enabled=e.enabled})}),n.getTracks().forEach(function(e){r.addTrack(e,n)})}},u.prototype.removeTrack=function(r){if(this._isClosed)throw d("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(r instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===r});if(!n)throw d("InvalidAccessError","Sender was not created by this connection.");var a=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null;var i=this.transceivers.map(function(e){return e.stream});-1===i.indexOf(a)&&-1<this.localStreams.indexOf(a)&&this.localStreams.splice(this.localStreams.indexOf(a),1),this._maybeFireNegotiationNeeded()},u.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var r=t.getSenders().find(function(t){return t.track===e});r&&t.removeTrack(r)})},u.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},u.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},u.prototype._createIceGatherer=function(t,r){var n=this;if(r&&0<t)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var a=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(a,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;a.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},a.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),a},u.prototype._gather=function(t,r){var n=this,a=this.transceivers[r].iceGatherer;if(!a.onlocalcandidate){var i=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,a.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),a.onlocalcandidate=function(e){if(!(n.usingBundle&&0<r)){var i=new Event("icecandidate");i.candidate={sdpMid:t,sdpMLineIndex:r};var o=e.candidate,s=!o||0===Object.keys(o).length;if(s)("new"===a.state||"gathering"===a.state)&&(a.state="completed");else{"new"===a.state&&(a.state="gathering"),o.component=1,o.ufrag=a.getLocalParameters().usernameFragment;var d=c.writeCandidate(o);i.candidate=Object.assign(i.candidate,c.parseCandidate(d)),i.candidate.candidate=d,i.candidate.toJSON=function(){return{candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,usernameFragment:i.candidate.usernameFragment}}}var p=c.getMediaSections(n._localDescription.sdp);p[i.candidate.sdpMLineIndex]+=s?"a=end-of-candidates\r\n":"a="+i.candidate.candidate+"\r\n",n._localDescription.sdp=c.getDescription(n._localDescription.sdp)+p.join("");var l=n.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),s||n._dispatchEvent("icecandidate",i),l&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout(function(){i.forEach(function(t){a.onlocalcandidate(t)})},0)}},u.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:n}},u.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},u.prototype._transceive=function(e,r,n){var a=i(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(a.encodings=e.sendEncodingParameters,a.rtcp={cname:c.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(a)),n&&e.rtpReceiver&&0<a.codecs.length&&("video"===e.kind&&e.recvEncodingParameters&&15019>t&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),a.encodings=e.recvEncodingParameters.length?e.recvEncodingParameters:[{}],a.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(a.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(a))},u.prototype.setLocalDescription=function(e){var t=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(d("TypeError","Unsupported type \""+e.type+"\""));if(!o("setLocalDescription",e.type,t.signalingState)||t._isClosed)return Promise.reject(d("InvalidStateError","Can not set local "+e.type+" in state "+t.signalingState));var r,n;if("offer"===e.type)r=c.splitSections(e.sdp),n=r.shift(),r.forEach(function(e,r){var n=c.parseRtpParameters(e);t.transceivers[r].localCapabilities=n}),t.transceivers.forEach(function(e,r){t._gather(e.mid,r)});else if("answer"===e.type){r=c.splitSections(t._remoteDescription.sdp),n=r.shift();var a=0<c.matchPrefix(n,"a=ice-lite").length;r.forEach(function(e,r){var o=t.transceivers[r],s=o.iceGatherer,d=o.iceTransport,p=o.dtlsTransport,l=o.localCapabilities,m=o.remoteCapabilities,u=c.isRejected(e)&&0===c.matchPrefix(e,"a=bundle-only").length;if(!u&&!o.rejected){var g=c.getIceParameters(e,n),f=c.getDtlsParameters(e,n);a&&(f.role="server"),t.usingBundle&&0!==r||(t._gather(o.mid,r),"new"===d.state&&d.start(s,g,a?"controlling":"controlled"),"new"===p.state&&p.start(f));var h=i(l,m);t._transceive(o,0<h.codecs.length,!1)}})}return t._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?t._updateSignalingState("have-local-offer"):t._updateSignalingState("stable"),Promise.resolve()},u.prototype.setRemoteDescription=function(r){var n=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(d("TypeError","Unsupported type \""+r.type+"\""));if(!o("setRemoteDescription",r.type,n.signalingState)||n._isClosed)return Promise.reject(d("InvalidStateError","Can not set remote "+r.type+" in state "+n.signalingState));var a={};n.remoteStreams.forEach(function(e){a[e.id]=e});var u=[],g=c.splitSections(r.sdp),f=g.shift(),h=0<c.matchPrefix(f,"a=ice-lite").length,v=0<c.matchPrefix(f,"a=group:BUNDLE ").length;n.usingBundle=v;var y=c.matchPrefix(f,"a=ice-options:")[0];return n.canTrickleIceCandidates=!!y&&0<=y.substr(14).split(" ").indexOf("trickle"),g.forEach(function(o,d){var m=c.splitLines(o),g=c.getKind(o),y=c.isRejected(o)&&0===c.matchPrefix(o,"a=bundle-only").length,S=m[0].substr(2).split(" ")[2],C=c.getDirection(o,f),b=c.parseMsid(o),T=c.getMid(o)||c.generateIdentifier();if(y||"application"===g&&("DTLS/SCTP"===S||"UDP/DTLS/SCTP"===S))return void(n.transceivers[d]={mid:T,kind:g,protocol:S,rejected:!0});!y&&n.transceivers[d]&&n.transceivers[d].rejected&&(n.transceivers[d]=n._createTransceiver(g,!0));var k,R,P,w,D,_,E,x,I,M,A,L=c.parseRtpParameters(o);y||(M=c.getIceParameters(o,f),A=c.getDtlsParameters(o,f),A.role="client"),E=c.parseRtpEncodingParameters(o);var j=c.parseRtcpParameters(o),O=0<c.matchPrefix(o,"a=end-of-candidates",f).length,V=c.matchPrefix(o,"a=candidate:").map(function(e){return c.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===r.type||"answer"===r.type)&&!y&&v&&0<d&&n.transceivers[d]&&(n._disposeIceAndDtlsTransports(d),n.transceivers[d].iceGatherer=n.transceivers[0].iceGatherer,n.transceivers[d].iceTransport=n.transceivers[0].iceTransport,n.transceivers[d].dtlsTransport=n.transceivers[0].dtlsTransport,n.transceivers[d].rtpSender&&n.transceivers[d].rtpSender.setTransport(n.transceivers[0].dtlsTransport),n.transceivers[d].rtpReceiver&&n.transceivers[d].rtpReceiver.setTransport(n.transceivers[0].dtlsTransport)),"offer"===r.type&&!y){k=n.transceivers[d]||n._createTransceiver(g),k.mid=T,k.iceGatherer||(k.iceGatherer=n._createIceGatherer(d,v)),V.length&&"new"===k.iceTransport.state&&(O&&(!v||0===d)?k.iceTransport.setRemoteCandidates(V):V.forEach(function(e){s(k.iceTransport,e)})),x=e.RTCRtpReceiver.getCapabilities(g),15019>t&&(x.codecs=x.codecs.filter(function(e){return"rtx"!==e.name})),_=k.sendEncodingParameters||[{ssrc:1001*(2*d+2)}];var G=!1;if("sendrecv"!==C&&"sendonly"!==C)k.rtpReceiver&&k.rtpReceiver.track&&(k.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===k.rtpReceiver.track.id});t&&l(t,e)}),k.associatedRemoteMediaStreams=[]);else if(G=!k.rtpReceiver,D=k.rtpReceiver||new e.RTCRtpReceiver(k.dtlsTransport,g),G){var F;I=D.track,b&&"-"===b.stream||(b?(!a[b.stream]&&(a[b.stream]=new e.MediaStream,Object.defineProperty(a[b.stream],"id",{get:function(){return b.stream}})),Object.defineProperty(I,"id",{get:function(){return b.track}}),F=a[b.stream]):(!a.default&&(a.default=new e.MediaStream),F=a.default)),F&&(p(I,F),k.associatedRemoteMediaStreams.push(F)),u.push([I,D,F])}k.localCapabilities=x,k.remoteCapabilities=L,k.rtpReceiver=D,k.rtcpParameters=j,k.sendEncodingParameters=_,k.recvEncodingParameters=E,n._transceive(n.transceivers[d],!1,G)}else if("answer"===r.type&&!y){k=n.transceivers[d],R=k.iceGatherer,P=k.iceTransport,w=k.dtlsTransport,D=k.rtpReceiver,_=k.sendEncodingParameters,x=k.localCapabilities,n.transceivers[d].recvEncodingParameters=E,n.transceivers[d].remoteCapabilities=L,n.transceivers[d].rtcpParameters=j,V.length&&"new"===P.state&&((h||O)&&(!v||0===d)?P.setRemoteCandidates(V):V.forEach(function(e){s(k.iceTransport,e)})),v&&0!==d||("new"===P.state&&P.start(R,M,"controlling"),"new"===w.state&&w.start(A));var U=i(k.localCapabilities,k.remoteCapabilities),N=U.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length;!N&&k.sendEncodingParameters[0].rtx&&delete k.sendEncodingParameters[0].rtx,n._transceive(k,"sendrecv"===C||"recvonly"===C,"sendrecv"===C||"sendonly"===C),D&&("sendrecv"===C||"sendonly"===C)?(I=D.track,b?(!a[b.stream]&&(a[b.stream]=new e.MediaStream),p(I,a[b.stream]),u.push([I,D,a[b.stream]])):(!a.default&&(a.default=new e.MediaStream),p(I,a.default),u.push([I,D,a.default]))):delete k.rtpReceiver}}),void 0===n._dtlsRole&&(n._dtlsRole="offer"===r.type?"active":"passive"),n._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?n._updateSignalingState("have-remote-offer"):n._updateSignalingState("stable"),Object.keys(a).forEach(function(t){var r=a[t];if(r.getTracks().length){if(-1===n.remoteStreams.indexOf(r)){n.remoteStreams.push(r);var i=new Event("addstream");i.stream=r,e.setTimeout(function(){n._dispatchEvent("addstream",i)})}u.forEach(function(e){var t=e[0],a=e[1];r.id!==e[2].id||m(n,t,a,[r])})}}),u.forEach(function(e){e[2]||m(n,e[0],e[1],[])}),e.setTimeout(function(){n&&n.transceivers&&n.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},u.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},u.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},u.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"!==this.signalingState||!0===this.needNegotiation||(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},u.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++}),e="new",0<t.failed?e="failed":0<t.checking?e="checking":0<t.disconnected?e="disconnected":0<t.new?e="new":0<t.connected?e="connected":0<t.completed&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},u.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)}),t.connected+=t.completed,e="new",0<t.failed?e="failed":0<t.connecting?e="connecting":0<t.disconnected?e="disconnected":0<t.new?e="new":0<t.connected&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},u.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(d("InvalidStateError","Can not call createOffer after close"));var a=r.transceivers.filter(function(e){return"audio"===e.kind}).length,i=r.transceivers.filter(function(e){return"video"===e.kind}).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(!0===o.offerToReceiveAudio?a=1:!1===o.offerToReceiveAudio?a=0:a=o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(!0===o.offerToReceiveVideo?i=1:!1===o.offerToReceiveVideo?i=0:i=o.offerToReceiveVideo)}for(r.transceivers.forEach(function(e){"audio"===e.kind?(a--,0>a&&(e.wantReceive=!1)):"video"===e.kind&&(i--,0>i&&(e.wantReceive=!1))});0<a||0<i;)0<a&&(r._createTransceiver("audio"),a--),0<i&&(r._createTransceiver("video"),i--);var s=c.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach(function(n,a){var i=n.track,o=n.kind,s=n.mid||c.generateIdentifier();n.mid=s,n.iceGatherer||(n.iceGatherer=r._createIceGatherer(a,r.usingBundle));var d=e.RTCRtpSender.getCapabilities(o);15019>t&&(d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name})),d.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),d.headerExtensions.forEach(function(e){var t=n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[];t.forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var p=n.sendEncodingParameters||[{ssrc:1001*(2*a+1)}];i&&15019<=t&&"video"===o&&!p[0].rtx&&(p[0].rtx={ssrc:p[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=d,n.sendEncodingParameters=p}),"max-compat"!==r._config.bundlePolicy&&(s+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n",r.transceivers.forEach(function(e,t){s+=n(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),s+="a=rtcp-rsize\r\n",e.iceGatherer&&"new"!==r.iceGatheringState&&(0===t||!r.usingBundle)&&(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,s+="a="+c.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(s+="a=end-of-candidates\r\n"))});var p=new e.RTCSessionDescription({type:"offer",sdp:s});return Promise.resolve(p)},u.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(d("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(d("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var a=c.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(a+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n";var o=c.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach(function(e,s){if(!(s+1>o)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?a+="m=application 0 DTLS/SCTP 5000\r\n":a+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(a+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");if(e.stream){var d;"audio"===e.kind?d=e.stream.getAudioTracks()[0]:"video"===e.kind&&(d=e.stream.getVideoTracks()[0]),d&&15019<=t&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1})}var c=i(e.localCapabilities,e.remoteCapabilities),p=c.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length;!p&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,a+=n(e,c,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}});var s=new e.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(s)},u.prototype.addIceCandidate=function(e){var t,r=this;return e&&!(void 0!==e.sdpMLineIndex||e.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(n,a){if(!r._remoteDescription)return a(d("InvalidStateError","Can not add ICE candidate without a remote description"));if(!e||""===e.candidate)for(var o=0;o<r.transceivers.length&&(r.transceivers[o].rejected||(r.transceivers[o].iceTransport.addRemoteCandidate({}),t=c.getMediaSections(r._remoteDescription.sdp),t[o]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=c.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));o++);else{var p=e.sdpMLineIndex;if(e.sdpMid)for(var l=0;l<r.transceivers.length;l++)if(r.transceivers[l].mid===e.sdpMid){p=l;break}var m=r.transceivers[p];if(m){if(m.rejected)return n();var u=0<Object.keys(e.candidate).length?c.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return n();if(u.component&&1!==u.component)return n();if((0===p||0<p&&m.iceTransport!==r.transceivers[0].iceTransport)&&!s(m.iceTransport,u))return a(d("OperationError","Can not add ICE candidate"));var g=e.candidate.trim();0===g.indexOf("a=")&&(g=g.substr(2)),t=c.getMediaSections(r._remoteDescription.sdp),t[p]+="a="+(u.type?g:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=c.getDescription(r._remoteDescription.sdp)+t.join("")}else return a(d("OperationError","Can not add ICE candidate"))}n()})},u.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)}),!r)throw d("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&n.push(e[t].getStats())})}),Promise.all(n).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var a=n.prototype.getStats;n.prototype.getStats=function(){return a.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(n){e[n].type=r(e[n]),t.set(n,e[n])}),t})}}});var g=["createOffer","createAnswer"];return g.forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),g=["setLocalDescription","setRemoteDescription","addIceCandidate"],g.forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=u.prototype[e];u.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),u}},{sdp:17}],17:[function(e,t){'use strict';var r={};r.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},r.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},r.getDescription=function(e){var t=r.splitSections(e);return t&&t[0]},r.getMediaSections=function(e){var t=r.splitSections(e);return t.shift(),t},r.matchPrefix=function(e,t){return r.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},r.parseCandidate=function(e){var t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var r={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];}return r},r.writeCandidate=function(e){var t=[e.foundation,e.component,e.protocol.toUpperCase(),e.priority,e.address||e.ip,e.port],r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},r.writeRtpMap=function(e){var t=e.payloadType;e.preferredPayloadType!==void 0&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1===r?"":"/"+r)+"\r\n"},r.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:0<t[0].indexOf("/")?t[0].split("/")[1]:"sendrecv",uri:t[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},r.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),a=0;a<n.length;a++)t=n[a].trim().split("="),r[t[0].trim()]=t[1];return r},r.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)}),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},r.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},r.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},r.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return-1<n?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},r.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},r.getMid=function(e){var t=r.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},r.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},r.getDtlsParameters=function(e,t){var n=r.matchPrefix(e+t,"a=fingerprint:");return{role:"auto",fingerprints:n.map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),r},r.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},r.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?r.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},r.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},r.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},r.getCryptoParameters=function(e,t){var n=r.matchPrefix(e+t,"a=crypto:");return n.map(r.parseCryptoLine)},r.getIceParameters=function(e,t){var n=r.matchPrefix(e+t,"a=ice-ufrag:")[0],a=r.matchPrefix(e+t,"a=ice-pwd:")[0];return n&&a?{usernameFragment:n.substr(12),password:a.substr(10)}:null},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},r.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=r.splitLines(e),a=n[0].split(" "),o=3;o<a.length;o++){var s=a[o],d=r.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(d){var c=r.parseRtpMap(d),p=r.matchPrefix(e,"a=fmtp:"+s+" ");switch(c.parameters=p.length?r.parseFmtp(p[0]):{},c.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(r.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase());break;default:}}}return r.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(r.parseExtmap(e))}),t},r.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=0<t.codecs.length?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0===e.preferredPayloadType?e.payloadType:e.preferredPayloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=r.writeRtpMap(e),n+=r.writeFmtp(e),n+=r.writeRtcpFb(e)});var a=0;return t.codecs.forEach(function(e){e.maxptime>a&&(a=e.maxptime)}),0<a&&(n+="a=maxptime:"+a+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){n+=r.writeExtmap(e)}),n},r.parseRtpEncodingParameters=function(e){var t,n=[],a=r.parseRtpParameters(e),i=-1!==a.fecMechanisms.indexOf("RED"),o=-1!==a.fecMechanisms.indexOf("ULPFEC"),s=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),d=0<s.length&&s[0].ssrc,c=r.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.substr(17).split(" ");return t.map(function(e){return parseInt(e,10)})});0<c.length&&1<c[0].length&&c[0][0]===d&&(t=c[0][1]),a.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:d,codecPayloadType:parseInt(e.parameters.apt,10)};d&&t&&(r.rtx={ssrc:t}),n.push(r),i&&(r=JSON.parse(JSON.stringify(r)),r.fec={ssrc:d,mechanism:o?"red+ulpfec":"red"},n.push(r))}}),0===n.length&&d&&n.push({ssrc:d});var p=r.matchPrefix(e,"b=");return p.length&&(p=0===p[0].indexOf("b=TIAS:")?parseInt(p[0].substr(7),10):0===p[0].indexOf("b=AS:")?.95*(1e3*parseInt(p[0].substr(5),10))-16000:void 0,n.forEach(function(e){e.maxBitrate=p})),n},r.parseRtcpParameters=function(e){var t={},n=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var a=r.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=0<a.length,t.compound=0===a.length;var i=r.matchPrefix(e,"a=rtcp-mux");return t.mux=0<i.length,t},r.parseMsid=function(e){var t,n=r.matchPrefix(e,"a=msid:");if(1===n.length)return t=n[0].substr(7).split(" "),{stream:t[0],track:t[1]};var a=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});if(0<a.length)return t=a[0].value.split(" "),{stream:t[0],track:t[1]}},r.parseSctpDescription=function(e){var t,n=r.parseMLine(e),a=r.matchPrefix(e,"a=max-message-size:");0<a.length&&(t=parseInt(a[0].substr(19),10)),isNaN(t)&&(t=65536);var i=r.matchPrefix(e,"a=sctp-port:");if(0<i.length)return{port:parseInt(i[0].substr(12),10),protocol:n.fmt,maxMessageSize:t};var o=r.matchPrefix(e,"a=sctpmap:");if(0<o.length){var s=r.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:t}}},r.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"===e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,t,n){var a,i=t===void 0?2:t;a=e?e:r.generateSessionId();return"v=0\r\no="+(n||"thisisadapterortc")+" "+a+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.writeMediaSection=function(e,t,n,a){var i=r.writeRtpDescription(e.kind,t);if(i+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),i+="a=mid:"+e.mid+"\r\n",i+=e.direction?"a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var o="msid:"+a.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+o,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),i},r.getDirection=function(e,t){for(var n=r.splitLines(e),a=0;a<n.length;a++)switch(n[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[a].substr(2);default:}return t?r.getDirection(t):"sendrecv"},r.getKind=function(e){var t=r.splitLines(e),n=t[0].split(" ");return n[0].substr(2)},r.isRejected=function(e){return"0"===e.split(" ",2)[1]},r.parseMLine=function(e){var t=r.splitLines(e),n=t[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},r.parseOLine=function(e){var t=r.matchPrefix(e,"o=")[0],n=t.substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},r.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=r.splitLines(e),n=0;n<t.length;n++)if(2>t[n].length||"="!==t[n].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=r)},{}]},{},[1])(1)});Janus.sessions={},Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),!!(26<=e&&e<=t)||Janus.extension.isInstalled()}return!0};var defaultExtension={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout(function(){var t=new Error("NavigatorUserMediaError");return t.name="The required Chrome extension is not installed: click <a href=\"#\">here</a> to install it. (NOTE: this will need you to refresh the page)",e(t)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var r=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var n=new Error("NavigatorUserMediaError");n.name="You cancelled the request for permission, giving up...",r(n)}else r(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))})}};Janus.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,r=e&&e.Promise||Promise,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},extension:e&&e.extension||defaultExtension,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,n){var a={method:n.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===n.verb&&(a.headers["Content-Type"]="application/json"),void 0!==n.withCredentials&&(a.credentials=!0===n.withCredentials?"include":n.withCredentials?n.withCredentials:"omit"),n.body&&(a.body=JSON.stringify(n.body));var i=t(e,a).catch(function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})});if(n.timeout){var o=new r(function(e,t){var r=setTimeout(function(){return clearTimeout(r),t({message:"Request timed out",timeout:n.timeout})},n.timeout)});i=r.race([i,o])}return i.then(function(e){return e.ok?typeof n.success==typeof Janus.noop?e.json().then(function(e){n.success(e)}).catch(function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:r.reject({message:"API call failed",response:e})}).catch(function(e){typeof n.error==typeof Janus.noop&&n.error(e.message||"<< internal error >>",e)}),i}}},Janus.useOldDependencies=function(e){var t=e&&e.jQuery||jQuery,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return t.isArray(e)},extension:e&&e.extension||defaultExtension,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,r){var n=r.body===void 0?{}:{contentType:"application/json",data:JSON.stringify(r.body)},a=r.withCredentials===void 0?{}:{xhrFields:{withCredentials:r.withCredentials}};return t.ajax(t.extend(n,a,{url:e,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(e){typeof r.success==typeof Janus.noop&&r.success(e)},error:function(e,t,n){typeof r.error==typeof Janus.noop&&r.error(t,n)}}))}}},Janus.noop=function(){},Janus.dataChanDefaultLabel="JanusDataChannel",Janus.endOfCandidates=null,Janus.init=function(e){if(e=e||{},e.callback="function"==typeof e.callback?e.callback:Janus.noop,Janus.initDone)e.callback();else{if(("undefined"==typeof console||"undefined"==typeof console.log)&&(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===e.debug||"all"===e.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var t of e.debug)"trace"===t?Janus.trace=console.trace.bind(console):"debug"===t?Janus.debug=console.debug.bind(console):"vdebug"===t?Janus.vdebug=console.debug.bind(console):"log"===t?Janus.log=console.log.bind(console):"warn"===t?Janus.warn=console.warn.bind(console):"error"===t?Janus.error=console.error.bind(console):console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')");Janus.log("Initializing library");var r=e.dependencies||Janus.useDefaultDependencies();Janus.isArray=r.isArray,Janus.webRTCAdapter=r.webRTCAdapter,Janus.httpAPICall=r.httpAPICall,Janus.newWebSocket=r.newWebSocket,Janus.extension=r.extension,Janus.extension.init(),Janus.listDevices=function(e,t){e="function"==typeof e?e:Janus.noop,null==t&&(t={audio:!0,video:!0}),Janus.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then(function(t){navigator.mediaDevices.enumerateDevices().then(function(r){Janus.debug(r),e(r);try{var n=t.getTracks();for(var a of n)a&&a.stop()}catch(t){}})}).catch(function(t){Janus.error(t),e([])}):(Janus.warn("navigator.mediaDevices unavailable"),e([]))},Janus.attachMediaStream=function(e,t){try{e.srcObject=t}catch(r){try{e.src=URL.createObjectURL(t)}catch(t){Janus.error("Error attaching stream to element")}}},Janus.reattachMediaStream=function(e,t){try{e.srcObject=t.srcObject}catch(r){try{e.src=t.src}catch(t){Janus.error("Error reattaching stream to element")}}};var n=0<=["iPad","iPhone","iPod"].indexOf(navigator.platform),a=n?"pagehide":"beforeunload",i=window["on"+a];if(window.addEventListener(a,function(){for(var e in Janus.log("Closing window"),Janus.sessions)Janus.sessions[e]&&Janus.sessions[e].destroyOnUnload&&(Janus.log("Destroying session "+e),Janus.sessions[e].destroy({unload:!0,notifyDestroyed:!1}));i&&"function"==typeof i&&i()}),Janus.safariVp8=!1,"safari"===Janus.webRTCAdapter.browserDetails.browser&&605<=Janus.webRTCAdapter.browserDetails.version)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var o of RTCRtpSender.getCapabilities("video").codecs)if(o&&o.mimeType&&"video/vp8"===o.mimeType.toLowerCase()){Janus.safariVp8=!0;break}Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var s=new RTCPeerConnection({},{});s.createOffer({offerToReceiveVideo:!0}).then(function(e){Janus.safariVp8=-1!==e.sdp.indexOf("VP8"),Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),s.close(),s=null})}if(Janus.unifiedPlan=!1,"firefox"===Janus.webRTCAdapter.browserDetails.browser&&59<=Janus.webRTCAdapter.browserDetails.version)Janus.unifiedPlan=!0;else if("chrome"===Janus.webRTCAdapter.browserDetails.browser&&72>Janus.webRTCAdapter.browserDetails.version)Janus.unifiedPlan=!1;else if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))Janus.unifiedPlan=!1;else{const e=new RTCPeerConnection;try{e.addTransceiver("audio"),Janus.unifiedPlan=!0}catch(t){}e.close()}Janus.initDone=!0,e.callback()}},Janus.isWebrtcSupported=function(){return!!window.RTCPeerConnection},Janus.isGetUserMediaAvailable=function(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)},Janus.randomString=function(e){for(var t,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",a=0;a<e;a++)t=Math.floor(Math.random()*r.length),n+=r.substring(t,t+1);return n};function Janus(e){function t(e){var t={high:9e5,medium:3e5,low:1e5};return void 0!==e&&null!==e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}function r(){if(null!=ee){if(Janus.debug("Long poll..."),!$)return void Janus.warn("Is the server down? (connected=false)");var t=z+"/"+ee+"?rid="+new Date().getTime();K&&(t=t+"&maxev="+K),Y&&(t=t+"&token="+encodeURIComponent(Y)),Q&&(t=t+"&apisecret="+encodeURIComponent(Q)),Janus.httpAPICall(t,{verb:"GET",withCredentials:H,success:n,timeout:Z,error:function(t,n){return Janus.error(t+":",n),ne++,3<ne?($=!1,void e.error("Lost connection to the server (is it down?)")):void r()}})}}function n(e,t){if(ne=0,O||void 0===ee||null===ee||!0===t||r(),!O&&Janus.isArray(e)){for(var a=0;a<e.length;a++)n(e[a],!0);return}if("keepalive"===e.janus)return void Janus.vdebug("Got a keepalive on session "+ee);if("ack"===e.janus){Janus.debug("Got an ack on session "+ee),Janus.debug(e);var o=e.transaction;if(o){var s=ae[o];s&&s(e),delete ae[o]}return}if("success"===e.janus){Janus.debug("Got a success on session "+ee),Janus.debug(e);var o=e.transaction;if(o){var s=ae[o];s&&s(e),delete ae[o]}return}if("trickle"===e.janus){var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var c=te[d];if(!c)return void Janus.debug("This handle is not attached to this session");var p=e.candidate;Janus.debug("Got a trickled candidate on session "+ee),Janus.debug(p);var l=c.webrtcStuff;l.pc&&l.remoteSdp?(Janus.debug("Adding remote candidate:",p),p&&!0!==p.completed?l.pc.addIceCandidate(p):l.pc.addIceCandidate(Janus.endOfCandidates)):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),!l.candidates&&(l.candidates=[]),l.candidates.push(p),Janus.debug(l.candidates))}else{if("webrtcup"===e.janus){Janus.debug("Got a webrtcup event on session "+ee),Janus.debug(e);var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var c=te[d];return c?void c.webrtcState(!0):void Janus.debug("This handle is not attached to this session")}if("hangup"===e.janus){Janus.debug("Got a hangup event on session "+ee),Janus.debug(e);var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var c=te[d];if(!c)return void Janus.debug("This handle is not attached to this session");c.webrtcState(!1,e.reason),c.hangup()}else if("detached"===e.janus){Janus.debug("Got a detached event on session "+ee),Janus.debug(e);var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var c=te[d];if(!c)return;c.detached=!0,c.ondetached(),c.detach()}else if("media"===e.janus){Janus.debug("Got a media event on session "+ee),Janus.debug(e);var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var c=te[d];if(!c)return void Janus.debug("This handle is not attached to this session");c.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){Janus.debug("Got a slowlink event on session "+ee),Janus.debug(e);var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var c=te[d];if(!c)return void Janus.debug("This handle is not attached to this session");c.slowLink(e.uplink,e.lost)}else{if("error"===e.janus){Janus.error("Ooops: "+e.error.code+" "+e.error.reason),Janus.debug(e);var o=e.transaction;if(o){var s=ae[o];s&&s(e),delete ae[o]}return}if("event"===e.janus){Janus.debug("Got a plugin event on session "+ee),Janus.debug(e);var d=e.sender;if(!d)return void Janus.warn("Missing sender...");var m=e.plugindata;if(!m)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+d+" ("+m.plugin+")");var u=m.data;Janus.debug(u);var c=te[d];if(!c)return void Janus.warn("This handle is not attached to this session");var g=e.jsep;g&&(Janus.debug("Handling SDP as well..."),Janus.debug(g));var f=c.onmessage;f?(Janus.debug("Notifying application..."),f(u,g)):Janus.debug("No provided notification callback")}else{if("timeout"===e.janus)return Janus.error("Timeout on session "+ee),Janus.debug(e),void(O&&V.close(3504,"Gateway timeout"));Janus.warn("Unknown message/event  '"+e.janus+"' on session "+ee),Janus.debug(e)}}}}function a(){if(z&&O&&$){F=setTimeout(a,X);var e={janus:"keepalive",session_id:ee,transaction:Janus.randomString(12)};Y&&(e.token=Y),Q&&(e.apisecret=Q),V.send(JSON.stringify(e))}}function i(t){var o=Janus.randomString(12),s={janus:"create",transaction:o};if(t.reconnect&&($=!1,s.janus="claim",s.session_id=ee,V&&(V.onopen=null,V.onerror=null,V.onclose=null,F&&(clearTimeout(F),F=null))),Y&&(s.token=Y),Q&&(s.apisecret=Q),!z&&Janus.isArray(U)&&(z=U[N],0===z.indexOf("ws")?(O=!0,Janus.log("Server #"+(N+1)+": trying WebSockets to contact Janus ("+z+")")):(O=!1,Janus.log("Server #"+(N+1)+": trying REST API to contact Janus ("+z+")"))),O){for(var d in V=Janus.newWebSocket(z,"janus-protocol"),G={error:function(){return(Janus.error("Error connecting to the Janus WebSockets server... "+z),Janus.isArray(U)&&!t.reconnect)?(N++,N==U.length)?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(z=null,void setTimeout(function(){i(t)},200)):void t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){ae[o]=function(e){return Janus.debug(e),"success"===e.janus?void(F=setTimeout(a,X),$=!0,ee=e.session_id?e.session_id:e.data.id,t.reconnect?Janus.log("Claimed session: "+ee):Janus.log("Created session: "+ee),Janus.sessions[ee]=re,t.success()):(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason))},V.send(JSON.stringify(s))},message:function(e){n(JSON.parse(e.data))},close:function(){z&&$&&($=!1,e.error("Lost connection to the server (is it down?)"))}},G)V.addEventListener(d,G[d]);return}Janus.httpAPICall(z,{verb:"POST",withCredentials:H,body:s,success:function(e){return Janus.debug(e),"success"===e.janus?void($=!0,ee=e.session_id?e.session_id:e.data.id,t.reconnect?Janus.log("Claimed session: "+ee):Janus.log("Created session: "+ee),Janus.sessions[ee]=re,r(),t.success()):(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason))},error:function(e,r){return(Janus.error(e+":",r),Janus.isArray(U)&&!t.reconnect)?(N++,N==U.length)?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(z=null,void setTimeout(function(){i(t)},200)):void(""===r?t.error(e+": Is the server down?"):t.error(e+": "+r))}})}function o(t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=!0===t.unload,n=!0;void 0!==t.notifyDestroyed&&null!==t.notifyDestroyed&&(n=!0===t.notifyDestroyed);var a=!0===t.cleanupHandles;if(Janus.log("Destroying session "+ee+" (unload="+r+")"),!ee)return Janus.warn("No session to destroy"),t.success(),void(n&&e.destroyed());if(a)for(var i in te)u(i,{noRequest:!0});if(!$)return Janus.warn("Is the server down? (connected=false)"),ee=null,void t.success();var o={janus:"destroy",transaction:Janus.randomString(12)};if(Y&&(o.token=Y),Q&&(o.apisecret=Q),r)return O?(V.onclose=null,V.close(),V=null):navigator.sendBeacon(z+"/"+ee,JSON.stringify(o)),Janus.log("Destroyed session:"),ee=null,$=!1,t.success(),void(n&&e.destroyed());if(O){o.session_id=ee;var s=function(){for(var e in G)V.removeEventListener(e,G[e]);V.removeEventListener("message",d),V.removeEventListener("error",c),F&&clearTimeout(F),V.close()},d=function(r){var a=JSON.parse(r.data);a.session_id==o.session_id&&a.transaction==o.transaction&&(s(),t.success(),n&&e.destroyed())},c=function(){s(),t.error("Failed to destroy the server: Is the server down?"),n&&e.destroyed()};return V.addEventListener("message",d),V.addEventListener("error",c),void V.send(JSON.stringify(o))}Janus.httpAPICall(z+"/"+ee,{verb:"POST",withCredentials:H,body:o,success:function(r){Janus.log("Destroyed session:"),Janus.debug(r),ee=null,$=!1,"success"!==r.janus&&Janus.error("Ooops: "+r.error.code+" "+r.error.reason),t.success(),n&&e.destroyed()},error:function(r,a){Janus.error(r+":",a),ee=null,$=!1,t.success(),n&&e.destroyed()}})}function s(e){if(e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:Janus.noop,e.iceState="function"==typeof e.iceState?e.iceState:Janus.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:Janus.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:Janus.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:Janus.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:Janus.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:Janus.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:Janus.noop,e.ondata="function"==typeof e.ondata?e.ondata:Janus.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:Janus.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:Janus.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:Janus.noop,!$)return Janus.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var t=e.plugin;if(!t)return Janus.error("Invalid plugin"),void e.error("Invalid plugin");var r=e.opaqueId,n=e.token?e.token:Y,a=Janus.randomString(12),i={janus:"attach",plugin:t,opaque_id:r,transaction:a};return n&&(i.token=n),Q&&(i.apisecret=Q),O?(ae[a]=function(r){if(Janus.debug(r),"success"!==r.janus)return Janus.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var a=r.data.id;Janus.log("Created handle: "+a);var i={session:re,plugin:t,id:a,token:n,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return a},getPlugin:function(){return t},getVolume:function(){return C(a,!0)},getRemoteVolume:function(){return C(a,!0)},getLocalVolume:function(){return C(a,!1)},isAudioMuted:function(){return b(a,!1)},muteAudio:function(){return T(a,!1,!0)},unmuteAudio:function(){return T(a,!1,!1)},isVideoMuted:function(){return b(a,!0)},muteVideo:function(){return T(a,!0,!0)},unmuteVideo:function(){return T(a,!0,!1)},getBitrate:function(){return k(a)},send:function(e){d(a,e)},data:function(e){l(a,e)},dtmf:function(e){m(a,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){f(a,!0,e)},createAnswer:function(e){f(a,!1,e)},handleRemoteJsep:function(e){h(a,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){P(a,!0===e)},detach:function(e){u(a,e)}};te[a]=i,e.success(i)},i.session_id=ee,void V.send(JSON.stringify(i))):void Janus.httpAPICall(z+"/"+ee,{verb:"POST",withCredentials:H,body:i,success:function(r){if(Janus.debug(r),"success"!==r.janus)return Janus.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var a=r.data.id;Janus.log("Created handle: "+a);var i={session:re,plugin:t,id:a,token:n,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return a},getPlugin:function(){return t},getVolume:function(){return C(a,!0)},getRemoteVolume:function(){return C(a,!0)},getLocalVolume:function(){return C(a,!1)},isAudioMuted:function(){return b(a,!1)},muteAudio:function(){return T(a,!1,!0)},unmuteAudio:function(){return T(a,!1,!1)},isVideoMuted:function(){return b(a,!0)},muteVideo:function(){return T(a,!0,!0)},unmuteVideo:function(){return T(a,!0,!1)},getBitrate:function(){return k(a)},send:function(e){d(a,e)},data:function(e){l(a,e)},dtmf:function(e){m(a,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){f(a,!0,e)},createAnswer:function(e){f(a,!1,e)},handleRemoteJsep:function(e){h(a,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){P(a,!0===e)},detach:function(e){u(a,e)}};te[a]=i,e.success(i)},error:function(t,r){Janus.error(t+":",r),""===r?e.error(t+": Is the server down?"):e.error(t+": "+r)}})}function d(e,t){if(t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop,!$)return Janus.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var r=te[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var n=t.message,a=t.jsep,i=Janus.randomString(12),o={janus:"message",body:n,transaction:i};return r.token&&(o.token=r.token),Q&&(o.apisecret=Q),a&&(o.jsep=a),Janus.debug("Sending message to plugin (handle="+e+"):"),Janus.debug(o),O?(o.session_id=ee,o.handle_id=e,ae[i]=function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return Janus.warn("Request succeeded, but missing plugindata..."),void t.success();Janus.log("Synchronous transaction successful ("+r.plugin+")");var n=r.data;return Janus.debug(n),void t.success(n)}return"ack"===e.janus?void t.success():void(e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),t.error("Unknown error")))},void V.send(JSON.stringify(o))):void Janus.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:H,body:o,success:function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return Janus.warn("Request succeeded, but missing plugindata..."),void t.success();Janus.log("Synchronous transaction successful ("+r.plugin+")");var n=r.data;return Janus.debug(n),void t.success(n)}return"ack"===e.janus?void t.success():void(e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),t.error("Unknown error")))},error:function(e,r){Janus.error(e+":",r),t.error(e+": "+r)}})}function c(e,t){if(!$)return void Janus.warn("Is the server down? (connected=false)");var r=te[e];if(!r||!r.webrtcStuff)return void Janus.warn("Invalid handle");var n={janus:"trickle",candidate:t,transaction:Janus.randomString(12)};return r.token&&(n.token=r.token),Q&&(n.apisecret=Q),Janus.vdebug("Sending trickle candidate (handle="+e+"):"),Janus.vdebug(n),O?(n.session_id=ee,n.handle_id=e,void V.send(JSON.stringify(n))):void Janus.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:H,body:n,success:function(e){if(Janus.vdebug("Candidate sent!"),Janus.vdebug(e),"ack"!==e.janus)return void Janus.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){Janus.error(e+":",t)}})}function p(e,t,r,n){var a=te[e];if(!a||!a.webrtcStuff)return void Janus.warn("Invalid handle");var i=a.webrtcStuff,o=function(e){Janus.log("Received state change on data channel:",e);var t=e.target.label,r=i.dataChannel[t]?i.dataChannel[t].readyState:"null";if(Janus.log("State change on <"+t+"> data channel: "+r),"open"===r){if(i.dataChannel[t].pending&&0<i.dataChannel[t].pending.length){Janus.log("Sending pending messages on <"+t+">:",i.dataChannel[t].pending.length);for(var n of i.dataChannel[t].pending)Janus.log("Sending data on data channel <"+t+">"),Janus.debug(n),i.dataChannel[t].send(n);i.dataChannel[t].pending=[]}a.ondataopen(t)}};i.dataChannel[t]=r?r:i.pc.createDataChannel(t,{ordered:!0}),i.dataChannel[t].onmessage=function(e){Janus.log("Received message on data channel:",e);var t=e.target.label;a.ondata(e.data,t)},i.dataChannel[t].onopen=o,i.dataChannel[t].onclose=o,i.dataChannel[t].onerror=function(e){Janus.error("Got error on data channel:",e)},i.dataChannel[t].pending=[],n&&i.dataChannel[t].pending.push(n)}function l(e,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=te[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var n=r.webrtcStuff,a=t.text||t.data;if(!a)return Janus.warn("Invalid data"),void t.error("Invalid data");var i=t.label?t.label:Janus.dataChanDefaultLabel;return n.dataChannel[i]?"open"===n.dataChannel[i].readyState?void(Janus.log("Sending data on data channel <"+i+">"),Janus.debug(a),n.dataChannel[i].send(a),t.success()):(n.dataChannel[i].pending.push(a),void t.success()):(p(e,i,!1,a),void t.success())}function m(e,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=te[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var n=r.webrtcStuff;if(!n.dtmfSender){if(n.pc){var a=n.pc.getSenders(),i=a.find(function(e){return e.track&&"audio"===e.track.kind});if(!i)return Janus.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=i.dtmf,n.dtmfSender&&(Janus.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){Janus.debug("Sent DTMF tone: "+e.tone)})}if(!n.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var o=t.dtmf;if(!o)return Janus.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var s=o.tones;if(!s)return Janus.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var d="number"==typeof o.duration?o.duration:500,c="number"==typeof o.gap?o.gap:50;Janus.debug("Sending DTMF string "+s+" (duration "+d+"ms, gap "+c+"ms)"),n.dtmfSender.insertDTMF(s,d,c),t.success()}function u(e,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=!0===t.noRequest;Janus.log("Destroying handle "+e+" (only-locally="+r+")"),P(e);var n=te[e];if(!n||n.detached)return delete te[e],void t.success();if(r)return delete te[e],void t.success();if(!$)return Janus.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var a={janus:"detach",transaction:Janus.randomString(12)};return n.token&&(a.token=n.token),Q&&(a.apisecret=Q),O?(a.session_id=ee,a.handle_id=e,V.send(JSON.stringify(a)),delete te[e],void t.success()):void Janus.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:H,body:a,success:function(r){Janus.log("Destroyed handle:"),Janus.debug(r),"success"!==r.janus&&Janus.error("Ooops: "+r.error.code+" "+r.error.reason),delete te[e],t.success()},error:function(r,n){Janus.error(r+":",n),delete te[e],t.success()}})}function g(e,r,n,a,o){var s=te[e];if(!s||!s.webrtcStuff)return Janus.warn("Invalid handle"),void a.error("Invalid handle");var d=s.webrtcStuff;Janus.debug("streamsDone:",o),o&&(Janus.debug("  -- Audio tracks:",o.getAudioTracks()),Janus.debug("  -- Video tracks:",o.getVideoTracks()));var l=!1;if(!d.myStream||!n.update||d.streamExternal)d.myStream=o,l=!0;else{if((!n.update&&D(n)||n.update&&(n.addAudio||n.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length)if(d.myStream.addTrack(o.getAudioTracks()[0]),Janus.unifiedPlan){Janus.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]);var m=null,u=d.pc.getTransceivers();if(u&&0<u.length)for(var g of u)if(g.sender&&g.sender.track&&"audio"===g.sender.track.kind||g.receiver&&g.receiver.track&&"audio"===g.receiver.track.kind){m=g;break}m&&m.sender?m.sender.replaceTrack(o.getAudioTracks()[0]):d.pc.addTrack(o.getAudioTracks()[0],o)}else Janus.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]),d.pc.addTrack(o.getAudioTracks()[0],o);if((!n.update&&x(n)||n.update&&(n.addVideo||n.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length)if(d.myStream.addTrack(o.getVideoTracks()[0]),Janus.unifiedPlan){Janus.log((n.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]);var f=null,u=d.pc.getTransceivers();if(u&&0<u.length)for(var g of u)if(g.sender&&g.sender.track&&"video"===g.sender.track.kind||g.receiver&&g.receiver.track&&"video"===g.receiver.track.kind){f=g;break}f&&f.sender?f.sender.replaceTrack(o.getVideoTracks()[0]):d.pc.addTrack(o.getVideoTracks()[0],o)}else Janus.log((n.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]),d.pc.addTrack(o.getVideoTracks()[0],o)}if(!d.pc){var h={iceServers:B,iceTransportPolicy:W,bundlePolicy:J};"chrome"===Janus.webRTCAdapter.browserDetails.browser&&(h.sdpSemantics=72>Janus.webRTCAdapter.browserDetails.version?"plan-b":"unified-plan");var C={optional:[{DtlsSrtpKeyAgreement:!0}]};if(q&&C.optional.push({googIPv6:!0}),a.rtcConstraints&&"object"==typeof a.rtcConstraints)for(var b in Janus.debug("Adding custom PeerConnection constraints:",a.rtcConstraints),a.rtcConstraints)C.optional.push(a.rtcConstraints[b]);"edge"===Janus.webRTCAdapter.browserDetails.browser&&(h.bundlePolicy="max-bundle"),Janus.log("Creating PeerConnection"),Janus.debug(C),d.pc=new RTCPeerConnection(h,C),Janus.debug(d.pc),d.pc.getStats&&(d.volume={},d.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+d.trickle+")"),d.pc.oniceconnectionstatechange=function(){d.pc&&s.iceState(d.pc.iceConnectionState)},d.pc.onicecandidate=function(t){if(!t.candidate||"edge"===Janus.webRTCAdapter.browserDetails.browser&&0<t.candidate.candidate.indexOf("endOfCandidates"))Janus.log("End of candidates."),d.iceDone=!0,!0===d.trickle?c(e,{completed:!0}):S(e,a);else{var r={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===d.trickle&&c(e,r)}},d.pc.ontrack=function(e){(Janus.log("Handling Remote Track"),Janus.debug(e),!!e.streams)&&(d.remoteStream=e.streams[0],s.onremotestream(d.remoteStream),e.track.onended||(Janus.log("Adding onended callback to track:",e.track),e.track.onended=function(e){Janus.log("Remote track muted/removed:",e),d.remoteStream&&(d.remoteStream.removeTrack(e.target),s.onremotestream(d.remoteStream))},e.track.onmute=e.track.onended,e.track.onunmute=function(e){Janus.log("Remote track flowing again:",e);try{d.remoteStream.addTrack(e.target),s.onremotestream(d.remoteStream)}catch(t){Janus.error(t)}}))}}if(l&&o){Janus.log("Adding local stream");var i=!0===a.simulcast2;o.getTracks().forEach(function(e){if(Janus.log("Adding local track:",e),!i)d.pc.addTrack(e,o);else if("audio"===e.kind)d.pc.addTrack(e,o);else{Janus.log("Enabling rid-based simulcasting:",e);const r=t(a.simulcastMaxBitrates);d.pc.addTransceiver(e,{direction:"sendrecv",streams:[o],sendEncodings:[{rid:"h",active:!0,maxBitrate:r.high},{rid:"m",active:!0,maxBitrate:r.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:r.low,scaleResolutionDownBy:4}]})}})}L(n)&&!d.dataChannel[Janus.dataChanDefaultLabel]&&(Janus.log("Creating data channel"),p(e,Janus.dataChanDefaultLabel,!1),d.pc.ondatachannel=function(t){Janus.log("Data channel created by Janus:",t),p(e,t.channel.label,t.channel)}),d.myStream&&s.onlocalstream(d.myStream),r?d.pc.setRemoteDescription(r).then(function(){if(Janus.log("Remote description accepted!"),d.remoteSdp=r.sdp,d.candidates&&0<d.candidates.length){for(var t,o=0;o<d.candidates.length;o++)t=d.candidates[o],Janus.debug("Adding remote candidate:",t),t&&!0!==t.completed?d.pc.addIceCandidate(t):d.pc.addIceCandidate(Janus.endOfCandidates);d.candidates=[]}y(e,n,a)},a.error):v(e,n,a)}function f(e,t,r){r=r||{},r.success="function"==typeof r.success?r.success:Janus.noop,r.error="function"==typeof r.error?r.error:R;var n=r.jsep;if(t&&n)return Janus.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!t&&(!n||!n.type||!n.sdp))return Janus.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");r.media="object"==typeof r.media&&r.media?r.media:{audio:!0,video:!0};var a=r.media,i=te[e];if(!i||!i.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var o=i.webrtcStuff;if(o.trickle=j(r.trickle),!o.pc)a.update=!1,a.keepAudio=!1,a.keepVideo=!1;else{if(Janus.log("Updating existing media session"),a.update=!0,r.stream)r.stream!==o.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(!a.addAudio)a.removeAudio?(a.keepAudio=!1,a.replaceAudio=!1,a.addAudio=!1,a.audioSend=!1):a.replaceAudio&&(a.keepAudio=!1,a.addAudio=!1,a.removeAudio=!1,a.audioSend=!0);else if(a.keepAudio=!1,a.replaceAudio=!1,a.removeAudio=!1,a.audioSend=!0,o.myStream&&o.myStream.getAudioTracks()&&o.myStream.getAudioTracks().length)return Janus.error("Can't add audio stream, there already is one"),void r.error("Can't add audio stream, there already is one");if(o.myStream?o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?D(a)&&!a.removeAudio&&!a.replaceAudio&&(a.keepAudio=!0):(a.replaceAudio&&(a.keepAudio=!1,a.replaceAudio=!1,a.addAudio=!0,a.audioSend=!0),D(a)&&(a.keepVideo=!1,a.addAudio=!0)):(a.replaceAudio&&(a.keepAudio=!1,a.replaceAudio=!1,a.addAudio=!0,a.audioSend=!0),D(a)&&(a.keepAudio=!1,a.addAudio=!0)),!a.addVideo)a.removeVideo?(a.keepVideo=!1,a.replaceVideo=!1,a.addVideo=!1,a.videoSend=!1):a.replaceVideo&&(a.keepVideo=!1,a.addVideo=!1,a.removeVideo=!1,a.videoSend=!0);else if(a.keepVideo=!1,a.replaceVideo=!1,a.removeVideo=!1,a.videoSend=!0,o.myStream&&o.myStream.getVideoTracks()&&o.myStream.getVideoTracks().length)return Janus.error("Can't add video stream, there already is one"),void r.error("Can't add video stream, there already is one");o.myStream?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?x(a)&&!a.removeVideo&&!a.replaceVideo&&(a.keepVideo=!0):(a.replaceVideo&&(a.keepVideo=!1,a.replaceVideo=!1,a.addVideo=!0,a.videoSend=!0),x(a)&&(a.keepVideo=!1,a.addVideo=!0)):(a.replaceVideo&&(a.keepVideo=!1,a.replaceVideo=!1,a.addVideo=!0,a.videoSend=!0),x(a)&&(a.keepVideo=!1,a.addVideo=!0)),a.addData&&(a.data=!0)}if(D(a)&&a.keepAudio&&x(a)&&a.keepVideo)return i.consentDialog(!1),void g(e,n,a,r,o.myStream)}if(a.update&&!o.streamExternal){if(a.removeAudio||a.replaceAudio){if(o.myStream&&o.myStream.getAudioTracks()&&o.myStream.getAudioTracks().length){var d=o.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",d),o.myStream.removeTrack(d);try{d.stop()}catch(t){}}if(o.pc.getSenders()&&o.pc.getSenders().length){var c=!0;if(a.replaceAudio&&Janus.unifiedPlan&&(c=!1),c)for(var d of o.pc.getSenders())d&&d.track&&"audio"===d.track.kind&&(Janus.log("Removing audio sender:",d),o.pc.removeTrack(d))}}if(a.removeVideo||a.replaceVideo){if(o.myStream&&o.myStream.getVideoTracks()&&o.myStream.getVideoTracks().length){var d=o.myStream.getVideoTracks()[0];Janus.log("Removing video track:",d),o.myStream.removeTrack(d);try{d.stop()}catch(t){}}if(o.pc.getSenders()&&o.pc.getSenders().length){var p=!0;if(a.replaceVideo&&Janus.unifiedPlan&&(p=!1),p)for(var d of o.pc.getSenders())d&&d.track&&"video"===d.track.kind&&(Janus.log("Removing video sender:",d),o.pc.removeTrack(d))}}}if(r.stream){var l=r.stream;if(Janus.log("MediaStream provided by the application"),Janus.debug(l),a.update&&o.myStream&&o.myStream!==r.stream&&!o.streamExternal){try{var m=o.myStream.getTracks();for(var u of m)Janus.log(u),u&&u.stop()}catch(t){}o.myStream=null}return o.streamExternal=!0,i.consentDialog(!1),void g(e,n,a,r,l)}if(D(a)||x(a)){if(!Janus.isGetUserMediaAvailable())return void r.error("getUserMedia not available");var f={mandatory:{},optional:[]};i.consentDialog(!0);var h=D(a);h&&a&&"object"==typeof a.audio&&(h=a.audio);var v=x(a);if(v&&a){var y=!0===r.simulcast,S=!0===r.simulcast2;if((y||S)&&!n&&!a.video&&(a.video="hires"),a.video&&"screen"!=a.video&&"window"!=a.video){if("object"==typeof a.video)v=a.video;else{var C=0,b=0,T=0;"lowres"===a.video?(b=240,T=240,C=320):"lowres-16:9"===a.video?(b=180,T=180,C=320):"hires"===a.video||"hires-16:9"===a.video||"hdres"===a.video?(b=720,T=720,C=1280):"fhdres"===a.video?(b=1080,T=1080,C=1920):"4kres"===a.video?(b=2160,T=2160,C=3840):"stdres"===a.video?(b=480,T=480,C=640):"stdres-16:9"===a.video?(b=360,T=360,C=640):(Janus.log("Default video setting is stdres 4:3"),b=480,T=480,C=640),Janus.log("Adding media constraint:",a.video),v={height:{ideal:b},width:{ideal:C}},Janus.log("Adding video constraint:",v)}}else if("screen"===a.video||"window"===a.video){function t(t,o){i.consentDialog(!1),t?r.error(t):g(e,n,a,r,o)}function o(e,t,r){Janus.log("Adding media constraint (screen capture)"),Janus.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){r?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(r){e.addTrack(r.getAudioTracks()[0]),t(null,e)}):t(null,e)}).catch(function(e){i.consentDialog(!1),t(e)})}if(a.screenshareFrameRate||(a.screenshareFrameRate=3),navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return void navigator.mediaDevices.getDisplayMedia({video:!0,audio:a.captureDesktopAudio}).then(function(t){i.consentDialog(!1),D(a)&&!a.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(i){t.addTrack(i.getAudioTracks()[0]),g(e,n,a,r,t)}):g(e,n,a,r,t)},function(e){i.consentDialog(!1),r.error(e)});if("chrome"===Janus.webRTCAdapter.browserDetails.browser){var k=Janus.webRTCAdapter.browserDetails.version,P=33;window.navigator.userAgent.match("Linux")&&(P=35),26<=k&&k<=P?(f={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:a.screenshareFrameRate,maxFrameRate:a.screenshareFrameRate,chromeMediaSource:"screen"}},audio:D(a)&&!a.keepAudio},o(f,t)):Janus.extension.getScreen(function(e,n){return e?(i.consentDialog(!1),r.error(e)):void(f={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:a.screenshareFrameRate,maxFrameRate:a.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}},f.video.mandatory.chromeMediaSourceId=n,o(f,t,D(a)&&!a.keepAudio))})}else if("firefox"===Janus.webRTCAdapter.browserDetails.browser)if(33<=Janus.webRTCAdapter.browserDetails.version)f={video:{mozMediaSource:a.video,mediaSource:a.video},audio:D(a)&&!a.keepAudio},o(f,function(e,r){if(t(e,r),!e)var n=r.currentTime,a=window.setInterval(function(){r||window.clearInterval(a),r.currentTime==n&&(window.clearInterval(a),r.onended&&r.onended()),n=r.currentTime},500)});else{var w=new Error("NavigatorUserMediaError");return w.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",i.consentDialog(!1),void r.error(w)}return}}a&&"screen"===a.video||navigator.mediaDevices.enumerateDevices().then(function(t){var o=t.some(function(e){return"audioinput"===e.kind}),s=A(a)||t.some(function(e){return"videoinput"===e.kind}),d=D(a),c=x(a),p=_(a),m=I(a);if(d||c||p||m){var u=!!d&&o,f=!!c&&s;if(!u&&!f)return i.consentDialog(!1),r.error("No capture device found"),!1;if(!u&&p)return i.consentDialog(!1),r.error("Audio capture is required, but no capture device found"),!1;if(!f&&m)return i.consentDialog(!1),r.error("Video capture is required, but no capture device found"),!1}var y={audio:o&&!a.keepAudio&&h,video:s&&!a.keepVideo&&v};Janus.debug("getUserMedia constraints",y),y.audio||y.video?navigator.mediaDevices.getUserMedia(y).then(function(t){i.consentDialog(!1),g(e,n,a,r,t)}).catch(function(e){i.consentDialog(!1),r.error({code:e.code,name:e.name,message:e.message})}):(i.consentDialog(!1),g(e,n,a,r,l))}).catch(function(e){i.consentDialog(!1),r.error("enumerateDevices error",e)})}else g(e,n,a,r)}function h(e,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:R;var r=t.jsep,n=te[e];if(!n||!n.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var a=n.webrtcStuff;if(r){if(!a.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");a.pc.setRemoteDescription(r).then(function(){if(Janus.log("Remote description accepted!"),a.remoteSdp=r.sdp,a.candidates&&0<a.candidates.length){for(var e,n=0;n<a.candidates.length;n++)e=a.candidates[n],Janus.debug("Adding remote candidate:",e),e&&!0!==e.completed?a.pc.addIceCandidate(e):a.pc.addIceCandidate(Janus.endOfCandidates);a.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}function v(e,r,n){n=n||{},n.success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:Janus.noop;var a=te[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var i=a.webrtcStuff,o=!0===n.simulcast;o?Janus.log("Creating offer (iceDone="+i.iceDone+", simulcast="+o+")"):Janus.log("Creating offer (iceDone="+i.iceDone+")");var s={};if(Janus.unifiedPlan){var d=null,c=null,p=i.pc.getTransceivers();if(p&&0<p.length)for(var l of p){if(l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind){d||(d=l);continue}if(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind){c||(c=l);continue}}var m=D(r),u=E(r);m||u?m&&u?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",d)):m&&!u?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",d)):!m&&u&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",d)):(d=i.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",d))):r.removeAudio&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting audio transceiver to inactive:",d));var g=x(r),f=M(r);g||f?g&&f?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",c)):g&&!f?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",c)):!g&&f&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",c)):(c=i.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",c))):r.removeVideo&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",Janus.log("Setting video transceiver to inactive:",c))}else s.offerToReceiveAudio=E(r),s.offerToReceiveVideo=M(r);var h=!0===n.iceRestart;h&&(s.iceRestart=!0),Janus.debug(s);var v=x(r);if(v&&o&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var y=i.pc.getSenders().find(function(e){return"video"==e.track.kind});if(y){var S=y.getParameters();S||(S={});const e=t(n.simulcastMaxBitrates);S.encodings=[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}],y.setParameters(S)}}i.pc.createOffer(s).then(function(e){Janus.debug(e);var t={type:e.type,sdp:e.sdp};return n.customizeSdp(t),e.sdp=t.sdp,Janus.log("Setting local description"),v&&o&&("chrome"===Janus.webRTCAdapter.browserDetails.browser||"safari"===Janus.webRTCAdapter.browserDetails.browser?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=w(e.sdp)):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e).catch(n.error),i.mediaConstraints=s,i.iceDone||i.trickle?void(Janus.log("Offer ready"),Janus.debug(n),n.success(e)):void Janus.log("Waiting for all candidates...")},n.error)}function y(e,r,n){n=n||{},n.success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:Janus.noop;var a=te[e];if(!a||!a.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var i=a.webrtcStuff,o=!0===n.simulcast;o?Janus.log("Creating answer (iceDone="+i.iceDone+", simulcast="+o+")"):Janus.log("Creating answer (iceDone="+i.iceDone+")");var s=null;if(Janus.unifiedPlan){s={};var d=null,c=null,p=i.pc.getTransceivers();if(p&&0<p.length)for(var l of p){if(l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind){d||(d=l);continue}if(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind){c||(c=l);continue}}var m=D(r),u=E(r);if(!m&&!u){if(r.removeAudio&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",Janus.log("Setting audio transceiver to inactive:",d)}catch(t){Janus.error(t)}}else if(m&&u){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",d)}catch(t){Janus.error(t)}}else if(m&&!u)try{d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",d))}catch(t){Janus.error(t)}else if(!m&&u)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",d)}catch(t){Janus.error(t)}else d=i.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",d);var g=x(r),f=M(r);if(!g&&!f){if(r.removeVideo&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",Janus.log("Setting video transceiver to inactive:",c)}catch(t){Janus.error(t)}}else if(g&&f){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",c)}catch(t){Janus.error(t)}}else if(g&&!f){if(c)try{c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",c)}catch(t){Janus.error(t)}}else if(!g&&f)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",c)}catch(t){Janus.error(t)}else c=i.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",c)}else s="firefox"===Janus.webRTCAdapter.browserDetails.browser||"edge"===Janus.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:E(r),offerToReceiveVideo:M(r)}:{mandatory:{OfferToReceiveAudio:E(r),OfferToReceiveVideo:M(r)}};Janus.debug(s);var h=x(r);if(h&&o&&"firefox"===Janus.webRTCAdapter.browserDetails.browser){Janus.log("Enabling Simulcasting for Firefox (RID)");var v=i.pc.getSenders()[1];Janus.log(v);var y=v.getParameters();Janus.log(y);const e=t(n.simulcastMaxBitrates);v.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:e.high},{rid:"medium",active:!0,priority:"medium",maxBitrate:e.medium},{rid:"low",active:!0,priority:"low",maxBitrate:e.low}]})}i.pc.createAnswer(s).then(function(e){Janus.debug(e);var t={type:e.type,sdp:e.sdp};return n.customizeSdp(t),e.sdp=t.sdp,Janus.log("Setting local description"),h&&o&&("chrome"===Janus.webRTCAdapter.browserDetails.browser?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e).catch(n.error),i.mediaConstraints=s,i.iceDone||i.trickle?void n.success(e):void Janus.log("Waiting for all candidates...")},n.error)}function S(e,t){t=t||{},t.success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=te[e];if(!r||!r.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var n=r.webrtcStuff;return Janus.log("Sending offer/answer SDP..."),n.mySdp?void(n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1),Janus.debug(t),n.sdpSent=!0,t.success(n.mySdp)):void Janus.warn("Local SDP instance is invalid, not sending anything...")}function C(e,t){var r=te[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),0;var n=t?"remote":"local",a=r.webrtcStuff;return a.volume[n]||(a.volume[n]={value:0}),a.pc.getStats&&("chrome"===Janus.webRTCAdapter.browserDetails.browser||"safari"===Janus.webRTCAdapter.browserDetails.browser)?t&&!a.remoteStream?(Janus.warn("Remote stream unavailable"),0):t||a.myStream?a.volume[n].timer?a.volume[n].value:(Janus.log("Starting "+n+" volume monitor"),a.volume[n].timer=setInterval(function(){a.pc.getStats().then(function(e){e.forEach(function(e){e&&"audio"===e.kind&&(!t||e.remoteSource)&&(t||"media-source"===e.type)&&(a.volume[n].value=e.audioLevel?e.audioLevel:0)})})},200),0):(Janus.warn("Local stream unavailable"),0):(Janus.warn("Getting the "+n+" volume unsupported by browser"),0)}function b(e,t){var r=te[e];if(!r||!r.webrtcStuff)return Janus.warn("Invalid handle"),!0;var n=r.webrtcStuff;return n.pc?n.myStream?t?n.myStream.getVideoTracks()&&0!==n.myStream.getVideoTracks().length?!n.myStream.getVideoTracks()[0].enabled:(Janus.warn("No video track"),!0):n.myStream.getAudioTracks()&&0!==n.myStream.getAudioTracks().length?!n.myStream.getAudioTracks()[0].enabled:(Janus.warn("No audio track"),!0):(Janus.warn("Invalid local MediaStream"),!0):(Janus.warn("Invalid PeerConnection"),!0)}function T(e,t,r){var n=te[e];if(!n||!n.webrtcStuff)return Janus.warn("Invalid handle"),!1;var a=n.webrtcStuff;return a.pc?a.myStream?t?a.myStream.getVideoTracks()&&0!==a.myStream.getVideoTracks().length?(a.myStream.getVideoTracks()[0].enabled=!r,!0):(Janus.warn("No video track"),!1):a.myStream.getAudioTracks()&&0!==a.myStream.getAudioTracks().length?(a.myStream.getAudioTracks()[0].enabled=!r,!0):(Janus.warn("No audio track"),!1):(Janus.warn("Invalid local MediaStream"),!1):(Janus.warn("Invalid PeerConnection"),!1)}function k(e){var t=te[e];if(!t||!t.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var r=t.webrtcStuff;return r.pc?r.pc.getStats?r.bitrate.timer?r.bitrate.value:(Janus.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval(function(){r.pc.getStats().then(function(e){e.forEach(function(e){if(e){var t=!1;if(("video"===e.mediaType||-1<e.id.toLowerCase().indexOf("video"))&&"inbound-rtp"===e.type&&0>e.id.indexOf("rtcp")?t=!0:"ssrc"==e.type&&e.bytesReceived&&("VP8"===e.googCodecName||""===e.googCodecName)&&(t=!0),t)if(r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var n=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"===Janus.webRTCAdapter.browserDetails.browser&&(n/=1e3);var a=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/n);"safari"===Janus.webRTCAdapter.browserDetails.browser&&(a=parseInt(a/1e3)),r.bitrate.value=a+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function R(e){Janus.error("WebRTC error:",e)}function P(e,t){Janus.log("Cleaning WebRTC stuff");var r=te[e];if(r){var n=r.webrtcStuff;if(n){if(!0===t){var a={janus:"hangup",transaction:Janus.randomString(12)};r.token&&(a.token=r.token),Q&&(a.apisecret=Q),Janus.debug("Sending hangup request (handle="+e+"):"),Janus.debug(a),O?(a.session_id=ee,a.handle_id=e,V.send(JSON.stringify(a))):Janus.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:H,body:a})}n.remoteStream=null,n.volume&&(n.volume.local&&n.volume.local.timer&&clearInterval(n.volume.local.timer),n.volume.remote&&n.volume.remote.timer&&clearInterval(n.volume.remote.timer)),n.volume={},n.bitrate.timer&&clearInterval(n.bitrate.timer),n.bitrate.timer=null,n.bitrate.bsnow=null,n.bitrate.bsbefore=null,n.bitrate.tsnow=null,n.bitrate.tsbefore=null,n.bitrate.value=null;try{if(!n.streamExternal&&n.myStream){Janus.log("Stopping local stream tracks");var i=n.myStream.getTracks();for(var o of i)Janus.log(o),o&&o.stop()}}catch(t){}n.streamExternal=!1,n.myStream=null;try{n.pc.close()}catch(t){}n.pc=null,n.candidates=null,n.mySdp=null,n.remoteSdp=null,n.iceDone=!1,n.dataChannel={},n.dtmfSender=null}r.oncleanup()}}function w(e){for(var t,r=e.split("\r\n"),n=!1,a=[-1],o=[-1],s=null,d=null,c=null,p=null,l=-1,m=0;m<r.length;m++){if(t=r[m].match(/m=(\w+) */),t){var u=t[1];if("video"===u){if(0>a[0])n=!0;else{l=m;break}}else if(-1<a[0]){l=m;break}continue}if(n){var g=r[m].match(/a=ssrc-group:FID (\d+) (\d+)/);if(g){a[0]=g[1],o[0]=g[2],r.splice(m,1),m--;continue}if(a[0]){var f=r[m].match("a=ssrc:"+a[0]+" cname:(.+)");if(f&&(s=f[1]),f=r[m].match("a=ssrc:"+a[0]+" msid:(.+)"),f&&(d=f[1]),f=r[m].match("a=ssrc:"+a[0]+" mslabel:(.+)"),f&&(c=f[1]),f=r[m].match("a=ssrc:"+a[0]+" label:(.+)"),f&&(p=f[1]),0===r[m].indexOf("a=ssrc:"+o[0])){r.splice(m,1),m--;continue}if(0===r[m].indexOf("a=ssrc:"+a[0])){r.splice(m,1),m--;continue}}if(0==r[m].length){r.splice(m,1),m--;continue}}}if(0>a[0]){l=-1,n=!1;for(var t,m=0;m<r.length;m++){if(t=r[m].match(/m=(\w+) */),t){var u=t[1];if("video"===u){if(0>a[0])n=!0;else{l=m;break}}else if(-1<a[0]){l=m;break}continue}if(n){if(0>a[0]){var h=r[m].match(/a=ssrc:(\d+)/);if(h){a[0]=h[1],r.splice(m,1),m--;continue}}else{var f=r[m].match("a=ssrc:"+a[0]+" cname:(.+)");if(f&&(s=f[1]),f=r[m].match("a=ssrc:"+a[0]+" msid:(.+)"),f&&(d=f[1]),f=r[m].match("a=ssrc:"+a[0]+" mslabel:(.+)"),f&&(c=f[1]),f=r[m].match("a=ssrc:"+a[0]+" label:(.+)"),f&&(p=f[1]),0===r[m].indexOf("a=ssrc:"+o[0])){r.splice(m,1),m--;continue}if(0===r[m].indexOf("a=ssrc:"+a[0])){r.splice(m,1),m--;continue}}if(0==r[m].length){r.splice(m,1),m--;continue}}}}if(0>a[0])return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;0>l&&(l=r.length),a[1]=Math.floor(4294967295*Math.random()),a[2]=Math.floor(4294967295*Math.random()),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random());for(var m=0;m<a.length;m++)s&&(r.splice(l,0,"a=ssrc:"+a[m]+" cname:"+s),l++),d&&(r.splice(l,0,"a=ssrc:"+a[m]+" msid:"+d),l++),c&&(r.splice(l,0,"a=ssrc:"+a[m]+" mslabel:"+c),l++),p&&(r.splice(l,0,"a=ssrc:"+a[m]+" label:"+p),l++),s&&(r.splice(l,0,"a=ssrc:"+o[m]+" cname:"+s),l++),d&&(r.splice(l,0,"a=ssrc:"+o[m]+" msid:"+d),l++),c&&(r.splice(l,0,"a=ssrc:"+o[m]+" mslabel:"+c),l++),p&&(r.splice(l,0,"a=ssrc:"+o[m]+" label:"+p),l++);return r.splice(l,0,"a=ssrc-group:FID "+a[2]+" "+o[2]),r.splice(l,0,"a=ssrc-group:FID "+a[1]+" "+o[1]),r.splice(l,0,"a=ssrc-group:FID "+a[0]+" "+o[0]),r.splice(l,0,"a=ssrc-group:SIM "+a[0]+" "+a[1]+" "+a[2]),e=r.join("\r\n"),e.endsWith("\r\n")||(e+="\r\n"),e}function D(e){return Janus.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function _(e){return Janus.debug("isAudioSendRequired:",e),!!e&&!1!==e.audio&&!1!==e.audioSend&&void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio}function E(e){return Janus.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function x(e){return Janus.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function I(e){return Janus.debug("isVideoSendRequired:",e),!!e&&!1!==e.video&&!1!==e.videoSend&&void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo}function M(e){return Janus.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}function A(e){if(Janus.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var t=e.video.mandatory;return t.chromeMediaSource?"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource:t.mozMediaSource?"window"===t.mozMediaSource||"screen"===t.mozMediaSource:!!t.mediaSource&&("window"===t.mediaSource||"screen"===t.mediaSource)}function L(e){return Janus.debug("isDataEnabled:",e),"edge"===Janus.webRTCAdapter.browserDetails.browser?(Janus.warn("Edge doesn't support data channels yet"),!1):void 0!==e&&null!==e&&!0===e.data}function j(e){return Janus.debug("isTrickleEnabled:",e),!1!==e}if(e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:Janus.noop,!Janus.initDone)return e.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),!e.server)return e.error("Invalid server url"),{};var O=!1,V=null,G={},F=null,U=null,N=0,z=e.server;Janus.isArray(z)?(Janus.log("Multiple servers provided ("+z.length+"), will use the first that works"),z=null,U=e.server,Janus.debug(U)):0===z.indexOf("ws")?(O=!0,Janus.log("Using WebSockets to contact Janus: "+z)):(O=!1,Janus.log("Using REST API to contact Janus: "+z));var B=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],W=e.iceTransportPolicy,J=e.bundlePolicy,q=!0===e.ipv6,H=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(H=!0===e.withCredentials);var K=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(K=e.max_poll_events),1>K&&(K=1);var Y=null;void 0!==e.token&&null!==e.token&&(Y=e.token);var Q=null;void 0!==e.apisecret&&null!==e.apisecret&&(Q=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var X=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(X=e.keepAlivePeriod),isNaN(X)&&(X=25e3);var Z=6e4;void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(Z=e.longPollTimeout),isNaN(Z)&&(Z=6e4);var $=!1,ee=null,te={},re=this,ne=0,ae={};i(e),this.getServer=function(){return z},this.isConnected=function(){return $},this.reconnect=function(e){e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.reconnect=!0,i(e)},this.getSessionId=function(){return ee},this.destroy=function(e){o(e)},this.attach=function(e){s(e)}}